# SPDX-License-Identifier: MIT
name: Generate and Release Keycaps

on:
  push:
    branches: [main, master]
    paths:
      - 'config.toml'
      - 'main.py'
      - 'models.py'
      - 'config.py'
      - 'assets/**'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-dejavu fonts-liberation fontconfig

      - name: Install custom fonts
        run: |
          mkdir -p ~/.local/share/fonts
          # Install Rajdhani from Google Fonts
          curl -L "https://fonts.google.com/download?family=Rajdhani" -o rajdhani.zip
          unzip rajdhani.zip -d ~/.local/share/fonts/
          # Refresh font cache
          fc-cache -fv

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync

      - name: Create results directory
        run: mkdir -p results

      - name: Generate keycaps
        run: uv run main.py
        continue-on-error: true  # Some glyphs may fail if fonts are missing

      - name: Create release zip
        run: |
          cd results
          zip -r ../keycaps-3mf.zip *.3mf || echo "No 3MF files generated"

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ steps.date.outputs.date }}
          name: Keycaps Build ${{ steps.date.outputs.date }}
          body: |
            Automatically generated keycap 3MF files.

            Download `keycaps-3mf.zip` and import into your slicer.
            Each 3MF contains separate bodies (cap, legend, stem) for multi-material printing.
          files: keycaps-3mf.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
